{% extends 'site_base.html' %}
{% block extra-head %}
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
<script>
var geocoder;

function geocodeAddress(){
    // Geocodes the location input and sets the lat and long fields

    var address, latlng;

    address  = $('#id_start_location').val()
    geocoder.geocode( {'address': address}, function(results, status){
        if (status == google.maps.GeocoderStatus.OK) {
            latlng = results[0].geometry.location;
            $('#id_start_latitude').val(latlng.lat());
            $('#id_start_longitude').val(latlng.lng());
            $('#search_form').data("geocodeset", true).submit();
        } else {
            alert('Geocode was not successful for the following reason: ' + status);
        }

    });
}

function update_length_slider_summary(slider_values){
    // Updates length inputs and summary according to the value of the length slider
    var summary,
        min = slider_values[ 0 ],
        max = slider_values[ 1 ];

    $( "#id_min_days" ).val( min );
    $( "#id_max_days" ).val( max );

    if ( min == max ){
        summary = min;
        if ( min == 1 ){
            summary += " day"
        } else {
            summary += " days"
        }
    } else {
        summary = min + " to " + max + " days"
    }
    $( "#length_summary" ).text( summary );
}

function set_up_sliders(){
    // Set up radius slider connected to radius input
    var select = $( "#id_radius" );
    var slider = $( "<div id='radius_slider'></div>" ).insertAfter( select ).slider({
        min: 1,
        max: 4000,
        step: 50,
        range: "min",
        value: select.val(),
        slide: function( event, ui ) {
            select.val(ui.value);
        }
    });
    $( "#id_radius" ).change(function() {
        slider.slider( "value", this.val() );
    });
    $( "<span>kilometers</span>" ).insertAfter(select);

    // Set up length slider connected to length min/max inputs
    var initial_min = $( "#id_min_days" ).val(),
        initial_max = $( "#id_max_days" ).val();

    $( "#length_slider" ).slider({
        range: true,
        min: 1,
        max: 10,
        values: [ initial_min, initial_max ],
        slide: function( event, ui ) {
            update_length_slider_summary(ui.values);
        }
    });

    // Initialize
    update_length_slider_summary($( "#length_slider" ).slider("option", "values"));
}

window.onload = function(){
    geocoder = new google.maps.Geocoder();
<<<<<<< HEAD
    $('#id_start_location').blur(geocodeAddress);
    $('#search_form').submit(geocodeAddress);
    set_up_sliders();
=======
    // $('#id_start_location').blur(geocodeAddress);

    // Delay submit until geocode call has completed
    $('#search_form').submit(function(event){
        if(!$(this).data("geocodeset")){
            geocodeAddress();
            return false;
        }
    })
>>>>>>> 29c998deb783572af6a04beb3f2cc68011050f27
}

</script>
{% endblock %}
{% block content %}
<form id="search_form" action="{% url 'results' %}">
{{ form.as_p }}
<p>
    <label for="length_slider">How long of a hike?</label>
    <div id="length_slider_container">
        <div id="length_summary" class="data-display"> </div>
        <div id="length_slider"> </div>
        <div id="length_slider_legend"> </div>{# TODO(#1): currently unused; probably do something like http://jsbin.com/ijekix/3/edit #}
    </div>
</p>
<input type="submit">
</form>
{% endblock %}